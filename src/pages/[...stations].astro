---
import StationManager from "../components/StationManager";
import Layout from "../layouts/Layout.astro";
import { fetchStations } from "../utils/api";

export async function getStaticPaths() {
	const stations = await fetchStations();
	const paths = [];

	// Add the default path (no stations selected)
	paths.push({ params: { stations: undefined } });

	// Generate all possible station combinations
	for (const fromStation of stations) {
		// Add single station paths
		paths.push({ params: { stations: fromStation.shortCode } });

		// Add station pairs
		for (const toStation of stations) {
			if (fromStation.shortCode !== toStation.shortCode) {
				paths.push({
					params: {
						stations: `${fromStation.shortCode}/${toStation.shortCode}`,
					},
				});
			}
		}
	}

	return paths;
}

const stations = await fetchStations();
const { stations: params } = Astro.params;

// Split the URL path into from and to station codes
const [fromStation, toStation] = params?.split("/") || [null, null];

// Validate that the stations exist in our station list
const isValidStation = (code: string | null) =>
	code && stations.some((station) => station.shortCode === code);

const validFromStation = isValidStation(fromStation) ? fromStation : null;
const validToStation = isValidStation(toStation) ? toStation : null;

// Get station names for SEO
const getStationName = (code: string | null) => {
	if (!code) return null;
	const station = stations.find((s) => s.shortCode === code);
	return station?.name || null;
};

const fromStationName = getStationName(validFromStation);
const toStationName = getStationName(validToStation);

// Generate dynamic title based on selected stations
const generateTitle = () => {
	if (fromStationName && toStationName) {
		return `${fromStationName} → ${toStationName} | Lähijunat Live`;
	}
	if (fromStationName) {
		return `${fromStationName} | Lähijunat Live`;
	}
	return "Lähijunat Live | Lähijunien aikataulut reaaliaikaisesti";
};

// Generate dynamic description based on selected stations
const generateDescription = () => {
	if (fromStationName && toStationName) {
		return `Reaaliaikaiset junat ${fromStationName} → ${toStationName}. Lähtöajat, raiteet ja viiveet.`;
	}
	if (fromStationName) {
		return `Reaaliaikaiset lähtevät junat asemalta ${fromStationName}. Lähtöajat, raiteet ja viiveet.`;
	}
	return "Reaaliaikaiset lähtöajat Suomen lähijunille. Saat ajantasaista tietoa lähijunien aikatauluista ja laitureista.";
};

// Generate breadcrumbs for structured data
const generateBreadcrumbs = () => {
	const siteUrl = Astro.site?.toString() || "https://www.lahijunat.live";
	const breadcrumbs = [
		{ name: "Etusivu", url: siteUrl }
	];

	if (fromStationName && validFromStation) {
		breadcrumbs.push({
			name: fromStationName,
			url: `${siteUrl}${validFromStation}`
		});
	}

	if (toStationName && validFromStation && validToStation) {
		breadcrumbs.push({
			name: toStationName,
			url: `${siteUrl}${validFromStation}/${validToStation}`
		});
	}

	return breadcrumbs;
};

const pageTitle = generateTitle();
const pageDescription = generateDescription();
const breadcrumbs = generateBreadcrumbs();
---

<Layout title={pageTitle} description={pageDescription} breadcrumbs={breadcrumbs}>
	<div class="py-4 sm:py-8">
		<StationManager
			client:load
			stations={stations}
			initialFromStation={validFromStation}
			initialToStation={validToStation}
		/>
	</div>
</Layout>
